name: Update Translation Files

on:
  workflow_dispatch:
    inputs:
      plugin_name:
        description: 'Plugin name Mosaic)'
        required: true
        default: 'Mosaic'
      plugin_root:
        description: 'Plugin root directory (optional)'
        required: false
        default: ''

jobs:
  update-translations:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. Install required tools
      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext
      
      # 4. Set environment and run update script
      - name: Update and compile translations
        env:
          PLUGIN_NAME: ${{ inputs.plugin_name }}
        run: |
          echo "========================================"
          echo "UPDATING TRANSLATIONS FOR: ${{ inputs.plugin_name }}"
          echo "========================================"
          
          # Run the Python script
          python .github/scripts/update_all_translations.py
      
      # 5. Check for changes
      - name: Check for changes
        id: check-changes
        run: |
          echo "Checking for changes..."
          if git diff --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "## ‚úÖ No updates needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No translation changes were required." >> $GITHUB_STEP_SUMMARY
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## üìù Changes detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Modified files:**" >> $GITHUB_STEP_SUMMARY
            git diff --name-only >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Summary of changes:**" >> $GITHUB_STEP_SUMMARY
            git diff --stat >> $GITHUB_STEP_SUMMARY
          fi
      
      # 6. Create Pull Request if changes detected
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update translation files for ${{ inputs.plugin_name }}"
          title: "üåç Update Translation Files (${{ inputs.plugin_name }})"
          body: |
            ## Automatic Translation Update
            
            **Plugin:** `${{ inputs.plugin_name }}`
            
            ### What was done:
            - ‚úÖ New strings extracted from `setup.xml` and `.py` files
            - ‚úÖ `${{ inputs.plugin_name }}.pot` template file updated
            - ‚úÖ All `.po` translation files updated with `msgmerge`
            - ‚úÖ All `.mo` binary files compiled
            - ‚úÖ Files synchronized between different directory structures
            
            ### Notes:
            - Existing translations were preserved
            - New strings appear as `msgstr ""` (empty, ready for translation)
            - Files are synced between `/po` directory and locale structures
            
            ### Changed files:
            The workflow has modified the translation files for this plugin.
            
            ---
            
            *This PR was automatically created by GitHub Actions.*
          branch: "update-translations-${{ inputs.plugin_name }}-${{ github.run_id }}"
          delete-branch: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 7. Final status
      - name: Final Status
        run: |
          if ${{ steps.check-changes.outputs.has_changes == 'true' }}; then
            echo "‚úÖ Translation update completed and PR created!"
          else
            echo "‚úÖ Translation check completed - no updates needed."
          fi